<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Text Selection Toolbar Demo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f7f7f5;
      min-height: 100vh;
      padding: 60px 20px;
    }

    .editor-container {
      max-width: 720px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      padding: 60px 72px;
      min-height: 400px;
    }

    .editor {
      outline: none;
      font-size: 16px;
      line-height: 1.7;
      color: #37352f;
    }

    .editor p {
      margin-bottom: 1em;
    }

    .editor h1 {
      font-size: 2em;
      font-weight: 700;
      margin-bottom: 0.5em;
    }

    .editor h2 {
      font-size: 1.5em;
      font-weight: 600;
      margin-bottom: 0.5em;
    }

    /* Selection Toolbar */
    .selection-toolbar {
      position: absolute;
      display: none;
      background: #1f1f1f;
      border-radius: 8px;
      padding: 4px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.2), 0 0 0 1px rgba(255,255,255,0.1);
      z-index: 1000;
      transform: translateX(-50%);
      animation: toolbar-appear 0.15s ease-out;
    }

    .selection-toolbar.visible {
      display: flex;
    }

    @keyframes toolbar-appear {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(4px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    .toolbar-group {
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .toolbar-divider {
      width: 1px;
      height: 24px;
      background: rgba(255,255,255,0.15);
      margin: 0 4px;
    }

    .toolbar-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      border-radius: 4px;
      cursor: pointer;
      color: #ffffffcc;
      transition: all 0.1s ease;
    }

    .toolbar-btn:hover {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }

    .toolbar-btn.active {
      background: rgba(255,255,255,0.15);
      color: #fff;
    }

    .toolbar-btn svg {
      width: 18px;
      height: 18px;
    }

    /* Dropdown buttons */
    .toolbar-dropdown-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 0 8px;
      height: 32px;
      border: none;
      background: transparent;
      border-radius: 4px;
      cursor: pointer;
      color: #ffffffcc;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.1s ease;
    }

    .toolbar-dropdown-btn:hover {
      background: rgba(255,255,255,0.1);
      color: #fff;
    }

    .toolbar-dropdown-btn svg {
      width: 12px;
      height: 12px;
      opacity: 0.7;
    }

    /* Color indicator */
    .color-indicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .color-indicator-bar {
      width: 14px;
      height: 3px;
      border-radius: 1px;
      background: currentColor;
    }

    /* Color Picker Dropdown */
    .color-picker-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.05);
      padding: 12px;
      display: none;
      min-width: 220px;
      z-index: 1001;
    }

    .color-picker-dropdown.visible {
      display: block;
      animation: dropdown-appear 0.15s ease-out;
    }

    @keyframes dropdown-appear {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-4px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    .color-section-title {
      font-size: 11px;
      font-weight: 600;
      color: #9b9a97;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .color-section + .color-section {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e8e8e8;
    }

    .color-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .color-option {
      width: 28px;
      height: 28px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      transition: transform 0.1s ease;
      position: relative;
    }

    .color-option:hover {
      transform: scale(1.1);
    }

    .color-option.selected::after {
      content: '';
      position: absolute;
      inset: 0;
      border: 2px solid #2383e2;
      border-radius: 4px;
    }

    /* Text colors */
    .color-default { background: #37352f; }
    .color-gray { background: #9b9a97; }
    .color-brown { background: #64473a; }
    .color-orange { background: #d9730d; }
    .color-yellow { background: #cb912f; }
    .color-green { background: #448361; }
    .color-blue { background: #337ea9; }
    .color-purple { background: #9065b0; }
    .color-pink { background: #c14c8a; }
    .color-red { background: #d44c47; }

    /* Background colors */
    .bg-default { background: transparent; border: 1px solid #e8e8e8; }
    .bg-gray { background: #ebeced; }
    .bg-brown { background: #e9e5e3; }
    .bg-orange { background: #faebdd; }
    .bg-yellow { background: #fbf3db; }
    .bg-green { background: #ddedea; }
    .bg-blue { background: #ddebf1; }
    .bg-purple { background: #eae4f2; }
    .bg-pink { background: #f4dfeb; }
    .bg-red { background: #fbe4e4; }

    /* Link input */
    .link-input-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.05);
      padding: 8px;
      display: none;
      width: 320px;
      z-index: 1001;
    }

    .link-input-dropdown.visible {
      display: block;
      animation: dropdown-appear 0.15s ease-out;
    }

    .link-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #e8e8e8;
      border-radius: 4px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s ease;
    }

    .link-input:focus {
      border-color: #2383e2;
    }

    /* Arrow indicator */
    .selection-toolbar::before {
      content: '';
      position: absolute;
      bottom: -6px;
      left: 50%;
      transform: translateX(-50%);
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 6px solid #1f1f1f;
    }

    /* Formatted text styles */
    .text-bold { font-weight: 700; }
    .text-italic { font-style: italic; }
    .text-underline { text-decoration: underline; }
    .text-strike { text-decoration: line-through; }
    .text-code {
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
      font-size: 0.9em;
      background: rgba(135,131,120,0.15);
      padding: 2px 4px;
      border-radius: 3px;
      color: #eb5757;
    }

    /* Highlight colors */
    .highlight-gray { background: #ebeced; }
    .highlight-brown { background: #e9e5e3; }
    .highlight-orange { background: #faebdd; }
    .highlight-yellow { background: #fbf3db; }
    .highlight-green { background: #ddedea; }
    .highlight-blue { background: #ddebf1; }
    .highlight-purple { background: #eae4f2; }
    .highlight-pink { background: #f4dfeb; }
    .highlight-red { background: #fbe4e4; }

    /* Text colors */
    .text-gray { color: #9b9a97; }
    .text-brown { color: #64473a; }
    .text-orange { color: #d9730d; }
    .text-yellow { color: #cb912f; }
    .text-green { color: #448361; }
    .text-blue { color: #337ea9; }
    .text-purple { color: #9065b0; }
    .text-pink { color: #c14c8a; }
    .text-red { color: #d44c47; }

    /* Tooltip */
    .tooltip {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: #1f1f1f;
      color: #fff;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s ease;
    }

    .toolbar-btn:hover .tooltip,
    .toolbar-dropdown-btn:hover .tooltip {
      opacity: 1;
    }

    .tooltip kbd {
      background: rgba(255,255,255,0.2);
      padding: 1px 4px;
      border-radius: 2px;
      font-family: inherit;
      margin-left: 6px;
    }

    /* Turn into dropdown */
    .turn-into-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.05);
      padding: 6px;
      display: none;
      min-width: 180px;
      z-index: 1001;
    }

    .turn-into-dropdown.visible {
      display: block;
      animation: dropdown-appear 0.15s ease-out;
    }

    .turn-into-option {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 6px 10px;
      border: none;
      background: transparent;
      border-radius: 4px;
      cursor: pointer;
      color: #37352f;
      font-size: 14px;
      text-align: left;
      transition: background 0.1s ease;
    }

    .turn-into-option:hover {
      background: #f7f6f3;
    }

    .turn-into-option svg {
      width: 20px;
      height: 20px;
      color: #9b9a97;
    }
  </style>
</head>
<body>
  <div class="editor-container">
    <div class="editor" contenteditable="true">
      <h1>Text Selection Toolbar Demo</h1>
      <p>这是一个类似 Notion 和飞书的文字选择工具栏演示。选中下面的文字试试看：</p>
      <p>The quick brown fox jumps over the lazy dog. 敏捷的棕色狐狸跳过了懒狗。这是一段可以被选中并格式化的文本。</p>
      <h2>功能特性</h2>
      <p>支持多种格式化操作：加粗、斜体、下划线、删除线、行内代码、链接、文字颜色和背景高亮。</p>
      <p>Try selecting some text to see the toolbar appear. You can apply formatting like <span class="text-bold">bold</span>, <span class="text-italic">italic</span>, <span class="text-code">code</span>, or add <span class="highlight-yellow">highlight colors</span>.</p>
    </div>
  </div>

  <!-- Selection Toolbar -->
  <div class="selection-toolbar" id="toolbar">
    <!-- Format buttons -->
    <div class="toolbar-group">
      <button class="toolbar-btn" id="boldBtn" title="加粗">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M7 5h6a4 4 0 0 1 0 8H7z"/>
          <path d="M7 13h7a4 4 0 0 1 0 8H7z"/>
          <line x1="7" y1="5" x2="7" y2="21"/>
        </svg>
        <span class="tooltip">加粗<kbd>⌘B</kbd></span>
      </button>
      <button class="toolbar-btn" id="italicBtn" title="斜体">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
          <line x1="19" y1="4" x2="10" y2="4"/>
          <line x1="14" y1="20" x2="5" y2="20"/>
          <line x1="15" y1="4" x2="9" y2="20"/>
        </svg>
        <span class="tooltip">斜体<kbd>⌘I</kbd></span>
      </button>
      <button class="toolbar-btn" id="underlineBtn" title="下划线">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <path d="M6 4v6a6 6 0 0 0 12 0V4M4 20h16"/>
        </svg>
        <span class="tooltip">下划线<kbd>⌘U</kbd></span>
      </button>
      <button class="toolbar-btn" id="strikeBtn" title="删除线">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <path d="M17.3 4.9c-1.2-1.1-2.9-1.4-4.4-1.4-2.4 0-5.1.8-5.1 3.8 0 1.3.5 2.2 1.5 2.9"/>
          <path d="M4 12h16"/>
          <path d="M19 17.5c0 2.3-2.1 3.5-5 3.5-1.7 0-3.2-.4-4.3-1.1"/>
        </svg>
        <span class="tooltip">删除线<kbd>⌘⇧S</kbd></span>
      </button>
      <button class="toolbar-btn" id="codeBtn" title="行内代码">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="16 18 22 12 16 6"/>
          <polyline points="8 6 2 12 8 18"/>
        </svg>
        <span class="tooltip">代码<kbd>⌘E</kbd></span>
      </button>
    </div>

    <div class="toolbar-divider"></div>

    <!-- Color -->
    <div class="toolbar-group" style="position: relative;">
      <button class="toolbar-btn" id="colorBtn" title="颜色">
        <div class="color-indicator">
          <svg viewBox="0 0 24 24" fill="currentColor" width="16" height="16">
            <path d="M12 4L5 20h2.5l1.5-4h6l1.5 4H19L12 4zm-1.5 10l1.5-4 1.5 4h-3z"/>
          </svg>
          <div class="color-indicator-bar" id="colorBar" style="background: #37352f;"></div>
        </div>
        <span class="tooltip">颜色</span>
      </button>
      <div class="color-picker-dropdown" id="colorDropdown">
        <div class="color-section">
          <div class="color-section-title">文字颜色</div>
          <div class="color-grid">
            <button class="color-option color-default selected" data-color="default" data-type="text" title="默认"></button>
            <button class="color-option color-gray" data-color="gray" data-type="text" title="灰色"></button>
            <button class="color-option color-brown" data-color="brown" data-type="text" title="棕色"></button>
            <button class="color-option color-orange" data-color="orange" data-type="text" title="橙色"></button>
            <button class="color-option color-yellow" data-color="yellow" data-type="text" title="黄色"></button>
            <button class="color-option color-green" data-color="green" data-type="text" title="绿色"></button>
            <button class="color-option color-blue" data-color="blue" data-type="text" title="蓝色"></button>
            <button class="color-option color-purple" data-color="purple" data-type="text" title="紫色"></button>
            <button class="color-option color-pink" data-color="pink" data-type="text" title="粉色"></button>
            <button class="color-option color-red" data-color="red" data-type="text" title="红色"></button>
          </div>
        </div>
        <div class="color-section">
          <div class="color-section-title">背景颜色</div>
          <div class="color-grid">
            <button class="color-option bg-default" data-color="default" data-type="bg" title="无背景"></button>
            <button class="color-option bg-gray" data-color="gray" data-type="bg" title="灰色"></button>
            <button class="color-option bg-brown" data-color="brown" data-type="bg" title="棕色"></button>
            <button class="color-option bg-orange" data-color="orange" data-type="bg" title="橙色"></button>
            <button class="color-option bg-yellow" data-color="yellow" data-type="bg" title="黄色"></button>
            <button class="color-option bg-green" data-color="green" data-type="bg" title="绿色"></button>
            <button class="color-option bg-blue" data-color="blue" data-type="bg" title="蓝色"></button>
            <button class="color-option bg-purple" data-color="purple" data-type="bg" title="紫色"></button>
            <button class="color-option bg-pink" data-color="pink" data-type="bg" title="粉色"></button>
            <button class="color-option bg-red" data-color="red" data-type="bg" title="红色"></button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    const toolbar = document.getElementById('toolbar');
    const editor = document.querySelector('.editor');
    const colorDropdown = document.getElementById('colorDropdown');

    let savedRange = null;

    // Format buttons
    const boldBtn = document.getElementById('boldBtn');
    const italicBtn = document.getElementById('italicBtn');
    const underlineBtn = document.getElementById('underlineBtn');
    const strikeBtn = document.getElementById('strikeBtn');
    const codeBtn = document.getElementById('codeBtn');
    const colorBtn = document.getElementById('colorBtn');

    // Close all dropdowns
    function closeAllDropdowns() {
      colorDropdown.classList.remove('visible');
    }

    // Show toolbar on text selection
    document.addEventListener('selectionchange', () => {
      const selection = window.getSelection();

      if (!selection.rangeCount || selection.isCollapsed) {
        // Delay hiding to allow clicking on toolbar
        setTimeout(() => {
          if (!toolbar.matches(':hover') && !colorDropdown.matches(':hover')) {
            toolbar.classList.remove('visible');
            closeAllDropdowns();
          }
        }, 100);
        return;
      }

      const range = selection.getRangeAt(0);

      // Check if selection is within editor
      if (!editor.contains(range.commonAncestorContainer)) {
        toolbar.classList.remove('visible');
        closeAllDropdowns();
        return;
      }

      savedRange = range.cloneRange();

      // Position toolbar above selection
      const rect = range.getBoundingClientRect();
      const toolbarRect = toolbar.getBoundingClientRect();

      toolbar.style.left = `${rect.left + rect.width / 2}px`;
      toolbar.style.top = `${rect.top - 50 + window.scrollY}px`;
      toolbar.classList.add('visible');

      // Update active states
      updateActiveStates();
    });

    // Update button active states based on current selection
    function updateActiveStates() {
      boldBtn.classList.toggle('active', document.queryCommandState('bold'));
      italicBtn.classList.toggle('active', document.queryCommandState('italic'));
      underlineBtn.classList.toggle('active', document.queryCommandState('underline'));
      strikeBtn.classList.toggle('active', document.queryCommandState('strikeThrough'));
    }

    // Restore selection
    function restoreSelection() {
      if (savedRange) {
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(savedRange);
      }
    }

    // Format text helper
    function formatText(command, value = null) {
      restoreSelection();
      document.execCommand(command, false, value);
      updateActiveStates();
    }

    // Format button handlers
    boldBtn.addEventListener('click', (e) => {
      e.preventDefault();
      formatText('bold');
    });

    italicBtn.addEventListener('click', (e) => {
      e.preventDefault();
      formatText('italic');
    });

    underlineBtn.addEventListener('click', (e) => {
      e.preventDefault();
      formatText('underline');
    });

    strikeBtn.addEventListener('click', (e) => {
      e.preventDefault();
      formatText('strikeThrough');
    });

    codeBtn.addEventListener('click', (e) => {
      e.preventDefault();
      restoreSelection();
      const selection = window.getSelection();
      if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        const selectedText = range.toString();
        const code = document.createElement('code');
        code.className = 'text-code';
        code.textContent = selectedText;
        range.deleteContents();
        range.insertNode(code);
      }
    });

    // Color picker toggle
    colorBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      colorDropdown.classList.toggle('visible');
    });

    // Color option click handlers
    document.querySelectorAll('.color-option').forEach(option => {
      option.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();

        const color = option.dataset.color;
        const type = option.dataset.type;

        restoreSelection();

        if (type === 'text') {
          // Text color
          const colorMap = {
            'default': '#37352f',
            'gray': '#9b9a97',
            'brown': '#64473a',
            'orange': '#d9730d',
            'yellow': '#cb912f',
            'green': '#448361',
            'blue': '#337ea9',
            'purple': '#9065b0',
            'pink': '#c14c8a',
            'red': '#d44c47'
          };
          document.execCommand('foreColor', false, colorMap[color] || '#37352f');
          document.getElementById('colorBar').style.background = colorMap[color] || '#37352f';
        } else {
          // Background color
          const bgMap = {
            'default': 'transparent',
            'gray': '#ebeced',
            'brown': '#e9e5e3',
            'orange': '#faebdd',
            'yellow': '#fbf3db',
            'green': '#ddedea',
            'blue': '#ddebf1',
            'purple': '#eae4f2',
            'pink': '#f4dfeb',
            'red': '#fbe4e4'
          };
          document.execCommand('backColor', false, bgMap[color] || 'transparent');
        }

        // Update selected state
        document.querySelectorAll(`.color-option[data-type="${type}"]`).forEach(o => {
          o.classList.remove('selected');
        });
        option.classList.add('selected');
      });
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', (e) => {
      if (!colorBtn.contains(e.target) && !colorDropdown.contains(e.target)) {
        colorDropdown.classList.remove('visible');
      }
    });

    // Keyboard shortcuts
    editor.addEventListener('keydown', (e) => {
      if (e.metaKey || e.ctrlKey) {
        switch (e.key.toLowerCase()) {
          case 'b':
            e.preventDefault();
            formatText('bold');
            break;
          case 'i':
            e.preventDefault();
            formatText('italic');
            break;
          case 'u':
            e.preventDefault();
            formatText('underline');
            break;
          case 'e':
            e.preventDefault();
            codeBtn.click();
            break;
        }
      }
    });

    // Prevent toolbar from hiding when interacting with it
    toolbar.addEventListener('mousedown', (e) => {
      e.preventDefault();
    });
  </script>
</body>
</html>
